{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "width": 1100,
  "height": 420,
  "title": {
    "text": "Australia: Arrivals, Departures, Net Overseas Migration",
    "fontSize": 16,
    "fontWeight": "bold",
    "anchor": "start"
  },
  "data": {
    "url": "https://raw.githubusercontent.com/loh-0/australian-migration/refs/heads/main/data/net_flow_migration.csv"
  },
  "params": [
    {
      "name": "yrSel",
      "value": 2023,
      "bind": {"input": "range", "min": 2004, "max": 2023, "step": 1, "name": "Year: "}
    }
  ],
  "transform": [
    {"fold": ["australian_born", "overseas_born", "total"], "as": ["series_key", "value"]},
    {
      "calculate": "datum.series_key === 'australian_born' ? 'Australian-born' : datum.series_key === 'overseas_born' ? 'Overseas-born' : 'Total (net)'",
      "as": "Series"
    }
  ],
  "layer": [
    {
      "mark": {"type": "line", "strokeWidth": 3},
      "encoding": {
        "x": {
          "field": "year",
          "type": "quantitative",
          "axis": {
            "format": "d",
            "title": "Year",
            "tickMinStep": 1,
            "labelFontSize": 12,
            "titleFontSize": 14
          }
        },
        "y": {
          "field": "value",
          "type": "quantitative",
          "title": "People",
          "axis": {
            "labelExpr": "format(datum.value, ',.0f')",
            "labelFontSize": 12,
            "titleFontSize": 14
          },
          "scale": {"nice": true, "domain": {"unionWith": [0]}}
        },
        "color": {
          "field": "Series",
          "scale": {
            "domain": ["Australian-born", "Overseas-born", "Total (net)"],
            "range": ["#2c5aa0", "#d9534f", "#5cb85c"]
          },
          "legend": {
            "title": "Series",
            "orient": "top-left",
            "labelFontSize": 12,
            "titleFontSize": 13,
            "symbolSize": 150,
            "offset": 10
          }
        },
        "tooltip": [
          {"field": "Series"},
          {"field": "year", "title": "Year"},
          {"field": "value", "title": "People", "format": ","}
        ]
      }
    },
    {
      "transform": [
        {"filter": "datum.year == yrSel"},
        {"aggregate": [{"op": "min", "field": "year", "as": "x"}]}
      ],
      "mark": {"type": "rule", "stroke": "#666", "strokeDash": [4,4]},
      "encoding": {"x": {"field": "x", "type": "quantitative"}}
    },
    {
      "transform": [{"filter": "datum.year == yrSel"}],
      "mark": {"type": "point", "filled": true, "size": 80, "stroke": "white", "strokeWidth": 1},
      "encoding": {
        "x": {"field": "year", "type": "quantitative"},
        "y": {"field": "value", "type": "quantitative"},
        "color": {"field": "Series", "legend": null}
      }
    },
    {
      "data": {
        "values": [
          {"year": 2009, "value": 300000, "text": "2009: GFC Impact", "subtext": "Migration declined sharply"},
          {"year": 2019.3, "value": 150000, "text": "2020: COVID-19 Pandemic", "subtext": "Border closures caused historic drop"},
          {"year": 2023, "value": 550000, "text": "2023: Record Recovery", "subtext": "Post-pandemic surge"}
        ]
      },
      "mark": {
        "type": "text",
        "fontSize": 11,
        "fontWeight": 600,
        "align": "center",
        "dy": -25
      },
      "encoding": {
        "x": {"field": "year", "type": "quantitative"},
        "y": {"field": "value", "type": "quantitative"},
        "text": {"field": "text"},
        "color": {"value": "#333"}
      }
    },
    {
      "data": {
        "values": [
          {"year": 2009, "value": 300000, "subtext": "Migration declined sharply"},
          {"year": 2019.3, "value": 150000, "subtext": "Border closures caused historic drop"},
          {"year": 2023, "value": 550000, "subtext": "Post-pandemic surge"}
        ]
      },
      "mark": {
        "type": "text",
        "fontSize": 10,
        "align": "center",
        "dy": -10,
        "fontStyle": "italic"
      },
      "encoding": {
        "x": {"field": "year", "type": "quantitative"},
        "y": {"field": "value", "type": "quantitative"},
        "text": {"field": "subtext"},
        "color": {"value": "#666"}
      }
    }
  ],
  "config": {
    "view": {"stroke": null},
    "background": "#f7fbff",
    "axis": {"grid": true, "gridOpacity": 0.15, "tickSize": 0}
  }
}
